<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>Goal Keepin</title>
<meta name="_csrf" th:content="${_csrf.token}">
<meta name="_csrf_header" th:content="${_csrf.headerName}">
<link rel="stylesheet" th:href="@{/css/bootstrap.css}">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" th:href="@{/css/richtext.min.css}">
<style>
header a, header li {
	margin-top: 10px;
	color: #777;
	font-weight: bold;
	color: #777
}

.row {
	margin: 15px 0 0 0;
}

header li {
	margin-left: 5px;
}

#challengeName input {
	width: 230px;
}

.forRecruiting, .forModifying {
	display: none;
}

#thumbnailImg img {
	width: 150px;
	height: 150px;
	border: 2px solid black;
}

#authMethod label {
	font-weight: normal;
	margin-right: 20px;
	margin-left: 5px;
}

#authMethod .col-md-3 span {
	font-weight: bold;
}

#authMethod input[type=number] {
	width: 50px;
}

#middlePart, #bottomPart {
	background-color: #fcfcfc;
	width: 98%; 
	border: 1px solid grey;
	border-top-width: 3px;
	padding: 20px;
	margin-bottom: 20px;
}

</style>
<body style="background-color: rgb(245, 247, 250);">
	<div class="row header">
		<header class="col-md-12 navbar-header">
			<h1 th:if="*{baseChallenge.baseNo == null}" class="brand pull-left h3">Create a project</h1>
			<h1 th:if="*{baseChallenge.baseNo != null}" class="brand pull-left h3">Details of created projects</h1>
			<ul th:if="*{baseChallenge != null and baseChallenge.baseNo != null}" class="list-inline list-unstyled pull-right" id="headerBtn">
				<li th:if="*{operatedChallengeCount > 0}"><a class="btn btn-primary" th:text="${'Project list (' + operatedChallengeCount + ')'}" id="showOperatedChallengeList" href="#">Project List</a></li>
				<li><a class="btn btn-primary" id="startRecruiting" href="#">Start a project</a></li>
				<li th:if="*{modifiable == 1}"><a class="btn btn-primary" href="#" id="modifyChallengeDetail">Edit</a></li>
			</ul>
		</header>
	</div>

	<form th:if="*{baseChallenge != null}" method="post" th:action="@{/challenge/processChallengeGeneration}" th:object="${baseChallenge}" enctype="multipart/form-data">
		<input th:if="*{baseNo != null}" type="hidden" id="baseNo" name="baseNo" th:value="*{baseNo}" /> <input th:if="*{baseNo != null}" type="hidden" id="baseNmTransNo" name="baseNmTransNo" th:value="*{baseNmTransNo}" /> <input th:if="*{baseNo != null}" type="hidden" id="baseAuthDescTransNo" name="baseAuthDescTransNo" th:value="*{baseAuthDescTransNo}" /> <input th:if="*{baseNo != null}" type="hidden" id="baseDetailTransNo" name="baseDetailTransNo" th:value="*{baseDetailTransNo}" />
	
		<section id="middlePart">
			<div class="row" id="challengeName">
				<div class="col-md-3">
					<h3 class="h5">Name of Project (English)</h3>
					<input type="text" name="baseNmEn" th:field="*{baseNmEn}" class="add" required="required" /> <span th:text="*{baseNmEn}" class="view"></span>
				</div>
				<div class="col-md-3">
					<h3 class="h5">Name of Project (Traditional)</h3>
					<input type="text" name="baseNmTc" th:field="*{baseNmTc}" class="add" required="required" /> <span th:text="*{baseNmTc}" class="view"></span>
				</div>
				<div class="col-md-3">
					<h3 class="h5">Name of Project (Simplified)</h3>
					<input type="text" name="baseNmSc" th:field="*{baseNmSc}" class="add" required="required" /> <span th:text="*{baseNmSc}" class="view"></span>
				</div>
				<div class="col-md-3" th:if="*{baseNo != null}">
					<h3 class="h5">Registration Date</h3>
					<span th:text="*{#dates.format(baseRegDate, 'yyyy.MM.dd HH:mm:ss')}"></span>
				</div>
			</div>
	
			<div class="row">
				<div class="col-md-12">
					<h3 class="h5">Habit type</h3>
					<select multiple="multiple" style="width: 100px;" th:size="${T(goalKeepin.constants.BaseHabitType).values().length}" name="baseHabitTypeCd" id="baseHabitTypeCd" th:field="*{baseHabitTypeCd}" class="add" required="required">
						<option th:each="habitType: ${T(goalKeepin.constants.BaseHabitType).values()}" th:value="${habitType}" th:text="${habitType.baseHabitTypeName}"></option>
					</select> <input type="hidden" name="searchKeyword" id="searchKeyword"> <span th:text="*{searchKeyword}" class="view">Base Habit Type Text</span>
				</div>
			</div>
	
	
			<div class="row">
				<div class="col-md-4" id="thumbnailImg">
					<h3 class="h5">Thumbnail image</h3>
					<input type="file" name="baseThumbnailUrl" th:field="*{baseThumbnailUrl}" class="add" required="required" />
					<img th:src="*{baseThumbnailUrl}" class="view" style="margin-left: 100px;">
				</div>
				<div class="col-md-4 forRecruiting">
					<h3 class="h5">Category setting</h3>
					<select name="categoryNo" id="categoryNo">
						<option th:each="category : ${categoryList}" th:value="${category.categoryNo}" th:utext="${category.categoryContent}">
					</select>
				</div>
				<div class="col-md-4 forRecruiting">
					<h3 class="h5">Level Restriction</h3>
					<select id="gradeCd" name="gradeCd">
						<option th:each="grade: ${T(goalKeepin.constants.ChallengeGrade).values()}" th:value="${grade}" th:text="${grade.gradeName}"></option>
					</select>
				</div>
			</div>

			<section class="forRecruiting">
				<div class="row">
					<div class="col-md-12">
						<div class="col-md-4">
							<h3 class="h5">Minimum participation fee</h3>
							<input type="number" name="minFee" id="minFee" style="width: 200px;" />
						</div>
						<div class="col-md-4">
							<h3 class="h5">Maximum participation fee</h3>
							<input type="number" name="minFee" id="maxFee" style="width: 200px;" />
						</div>
					</div>
				</div>
				<div class="row">
					<div class="col-md-12">
						<div class="col-md-4">
							<h3 class="h5">Start date</h3>
							<input type="date" name="startDate" id="startDate" style="width: 200px;" />
						</div>
						<div class="col-md-4">
							<h3 class="h5">Start date</h3>
							<input type="date" name="endDate" id="endDate" style="width: 200px;" />
						</div>
					</div>
				</div>
			</section>
		</section>

		<section id="bottomPart">
			<section id="authMethod">
				<div class="row">
					<h2 class="h3">Verification Method</h2>
				</div>
				<div class="row">
					<div class="col-md-3">
						<span>Available day for verification</span>
					</div>
					<div class="col-md-9">
						<div class="add">
							<input type="radio" name="baseAuthDateCd" value="AD01" id="baseAuthDateCd1" th:field="*{baseAuthDateCd}" required="required" /><label for="baseAuthDateCd1">Mon-Fri</label> <input type="radio" name="baseAuthDateCd" value="AD02" id="baseAuthDateCd2" th:field="*{baseAuthDateCd}" required="required" /><label for="baseAuthDateCd2">Sat-Sun</label> <input type="radio" name="baseAuthDateCd" value="AD03" id="baseAuthDateCd3" th:field="*{baseAuthDateCd}" required="required" /><label for="baseAuthDateCd3">Mon-Sun</label>
						</div>
						<div class="view">
							<span th:if="*{baseAuthDateCd == 'AD01'}" th:text="'Mon/Tue/Wed/Thu/Fri'"></span> <span th:if="*{baseAuthDateCd == 'AD02'}" th:text="'Sat/Sun'"></span> <span th:if="*{baseAuthDateCd == 'AD03'}" th:text="'Mon/Tue/Wed/Thu/Fri/Sat/Sun'"></span>
						</div>
					</div>
				</div>
	
				<div class="row">
					<div class="col-md-3">
						<span>Verification Frequency</span>
					</div>
					<div class="col-md-9">
						<div class="add">
							<input type="number" name="baseAuthFrequency" th:field="*{baseAuthFrequency}" id="baseAuthFrequency" required="required" />Days per week <input type="checkbox" id="everyday" /><label for="everyday">Everyday</label>
						</div>
						<div class="view">
							<span th:text="*{baseAuthFrequency}"></span> <span th:if="*{(baseAuthDateCd == 'AD01' and baseAuthFrequency == 5)
										or (baseAuthDateCd == 'AD02' and baseAuthFrequency == 2)
										or (baseAuthDateCd == 'AD03' and baseAuthFrequency == 7)}" th:text="'(Everyday)'"></span>
						</div>
					</div>
				</div>
	
				<div class="row">
					<div class="col-md-3">
						<span>Available time period for verification</span>
					</div>
					<div class="col-md-9">
						<div class="add">
							<input type="time" name="baseAuthFromTime" id="baseAuthFromTime" th:field="*{baseAuthFromTime}" required="required" /> ~ <input type="time" name="baseAuthToTime" id="baseAuthToTime" th:field="*{baseAuthToTime}" required="required" /> <input type="checkbox" id="allHours" /> <label for="allHours">24 Hours</label>
						</div>
						<div class="view">
							<span th:text="*{baseAuthFromTime}"></span> ~ <span th:text="*{baseAuthToTime}"></span>
						</div>
					</div>
				</div>
	
				<div class="row">
					<div class="col-md-3">
						<span>Number of verification per day</span>
					</div>
					<div class="col-md-9">
						<div class="add">
							<input type="number" id="baseAuthNumDaily" name="baseAuthNumDaily" th:field="*{baseAuthNumDaily}" required /> Times
						</div>
						<div class="view">
							<span th:text="*{baseAuthNumDaily}"></span> Times
						</div>
					</div>
				</div>
	
				<div class="row">
					<div class="col-md-3">
						<span>Verification Method</span>
					</div>
					<div class="col-md-9">
						<div class="add">
							<input type="radio" name="baseAuthMethodCd" value="AU01" id="photo" th:field="*{baseAuthMethodCd}" required="required" /><label for="photo">Photo</label> <input type="radio" name="baseAuthMethodCd" value="AU02" id="audio" th:field="*{baseAuthMethodCd}" required="required" /><label for="audio">Voice</label>
						</div>
						<div class="view">
							<span th:if="*{baseAuthMethodCd == 'AU01'}" th:text="'Photo'"></span> <span th:if="*{baseAuthMethodCd == 'AU02'}" th:text="'Voice'"></span>
						</div>
					</div>
				</div>
	
				<div class="row">
					<div class="col-md-3">
						<span>Contents Privacy</span>
					</div>
					<div class="col-md-9">
						<div class="add">
							<input type="radio" name="baseAuthIsOpen" value="1" id="photoShown" th:field="*{baseAuthIsOpen}" required="required" /><label for="photoShown">Public</label> <input type="radio" name="baseAuthIsOpen" value="0" id="photoHidden" th:field="*{baseAuthIsOpen}" required="required" /><label for="photoHidden">Private</label>
						</div>
						<div class="view">
							<span th:if="*{baseAuthIsOpen == 1}" th:text="'Public'"></span> <span th:if="*{baseAuthIsOpen == 0}" th:text="'Private'"></span>
						</div>
					</div>
				</div>
	
				<div class="row">
					<div class="col-md-3">
						<span>Verification Frequency</span>
					</div>
					<div class="col-md-9">
						<div class="add">
							<span id="intervalItem"> <input type="number" name="baseAuthInterval" id="baseAuthInterval" th:field="*{baseAuthInterval}" required="required" /><label>Hours</label>
							</span> <input type="checkbox" id="noLimit" /><label for="noLimit">No limit</label>
						</div>
						<div class="view">
							<span th:if="*{baseAuthInterval != 0}" th:text="*{baseAuthInterval} + ' Hours'"></span> <span th:if="*{baseAuthInterval == 0}" th:text="'No limit'"></span>
						</div>
					</div>
				</div>
				
	
				<div class="row">
					<div class="col-md-3">
						<span>Photo album Availability</span>
					</div>
					<div class="col-md-9">
						<div class="add">
							<input type="radio" name="baseAuthIsAlbum" value="1" id="albumAvaliable" th:field="*{baseAuthIsAlbum}" required="required" /><label for="albumAvaliable">Possible</label> <input type="radio" name="baseAuthIsAlbum" value="0" id="albumNotavaliable" th:field="*{baseAuthIsAlbum}" required="required" /><label for="albumNotavaliable">Impossible</label>
						</div>
						<div class="view">
							<span th:if="*{baseAuthIsAlbum == 1}" th:text="'Possible'"></span> <span th:if="*{baseAuthIsAlbum == 0}" th:text="'Impossible'"></span>
						</div>
					</div>
				</div>
			</section>
	
			<section id="challengeDetail">
				<div class="row">
					<div>
						<h3 class="h5">Detailed Description (English)</h3>
					</div>
					<div class="col-md-10">
						<div class="add">
							<textarea rows="5" style="width: 100%;" name="baseAuthDescEn" th:field="*{baseAuthDescEn}" id="baseAuthDescEn" placeholder="Please fill in the content." required="required"></textarea>
						</div>
						<div class="view" th:text="*{baseAuthDescEn}"></div>
					</div>
				</div>
				<div class="row">
					<div>
						<h3 class="h5">Detailed Description (Traditional)</h3>
					</div>
					<div class="col-md-10">
						<div class="add">
							<textarea rows="5" style="width: 100%;" name="baseAuthDescTc" th:field="*{baseAuthDescTc}" id="baseAuthDescTc" placeholder="Please fill in the content." required="required"></textarea>
						</div>
						<div class="view" th:text="*{baseAuthDescTc}"></div>
					</div>
				</div>
				<div class="row">
					<div>
						<h3 class="h5">Detailed Description (Simplified)</h3>
					</div>
					<div class="col-md-10">
						<div class="add">
							<textarea rows="5" style="width: 100%;" name="baseAuthDescSc" th:field="*{baseAuthDescSc}" id="baseAuthDescSc" placeholder="Please fill in the content." required="required"></textarea>
						</div>
						<div class="view" th:text="*{baseAuthDescSc}"></div>
					</div>
				</div>
			</section>
		</section>
		
		<section>
			<div class="row">
				<div>
					<h2 class="h5">Project details (English)</h2>
				</div>
				<div class="page-wrapper box-content col-md-11">
					<textarea class="content1" name="baseDetailEn" id="baseDetailEn" th:field="*{baseDetailEn}" required></textarea>
				</div>
			</div>
			<div class="row">
				<div>
					<h2 class="h5">Project details (Traditional)</h2>
				</div>
				<div class="page-wrapper box-content col-md-11">
					<textarea class="content2" name="baseDetailTc" id="baseDetailTc" th:field="*{baseDetailTc}" required></textarea>
				</div>
			</div>
			<div class="row">
				<div>
					<h2 class="h5">Project details (Simplified)</h2>
				</div>
				<div class="page-wrapper box-content col-md-11">
					<textarea class="content3" name="baseDetailSc" id="baseDetailSc" th:field="*{baseDetailSc}" required></textarea>
				</div>
			</div>
		</section>
		
		<section style="margin-bottom: 40px;">
			<div class="row text-center col-md-11">
				<input th:if="*{baseNo == null}" type="submit" value="Create a project" class="btn btn-primary" id="createChallenge" />
			</div>
			<div class="row forRecruiting text-center col-md-11">
				<a id="createChallengeDetail" class="btn btn-primary">Start a project</a>
			</div>
			<div class="row forModifying text-center col-md-11">
				<input id="doModifyChallengeDetail" type="submit" class="btn btn-primary" value="Edit" />
			</div>
		</section>
	</form>
	<script type="text/javascript" th:src="@{/js/jquery.js}"></script>
	<script type="text/javascript" th:src="@{/js/jquery.richtext.js}"></script>
	<script th:inline="javascript" th:if="*{baseChallenge != null}">
    	var baseHabitTypeCd = /*[[*{baseChallenge.baseHabitTypeCd}]]*/ null;
    	var baseDetailEn = /*[[*{baseChallenge.baseDetailEn}]]*/ null;
    	var baseDetailTc = /*[[*{baseChallenge.baseDetailTc}]]*/ null;
    	var baseDetailSc = /*[[*{baseChallenge.baseDetailSc}]]*/ null;
	</script>

	<script type="text/javascript">
		$(function() {
			 $('.content1').richText();
			 $('.content2').richText();
			 $('.content3').richText();
			 
			 var isCreatingBaseChallenge = [[*{baseChallenge != null and baseChallenge.baseNo == null}]];
			 
			 if(isCreatingBaseChallenge) {
				 // 생성 
				 $('.view').css('display', 'none');
			 } else {
				 // 보기
				 $('.richText-editor').attr('contenteditable', false);
				 $('.add').css('display', 'none');
				 
				 // 선택된 습관 타입 보여주기
				 $("#baseHabitTypeCd").val(baseHabitTypeCd.split(','));
			 }
			 
			 // 챌린지 정보 수정하기 버튼 처리
			 $('#modifyChallengeDetail').click(function() {
				 $('.richText-editor').attr('contenteditable', true);
				 $('.add').fadeIn('slow');
				 $('.view').css('display', 'none');
				 $('.forModifying').show('slow');
				 $('#baseThumbnailUrl').removeAttr('required');
				 
				 $('<li><a href="#" class="btn btn-primary">Cancel Editing</a></li>')
				 .appendTo('#headerBtn')
				 .siblings('li')
				 .hide()
				 .end()
				 .click(function() {
					 $(this)
					 .siblings('li')
					 .show()
					 .end()
					 .remove();
					 
					 $('.add').css('display', 'none');
					 $('.view').css('display', 'block');
					 
					 $('.richText-editor:eq(0)').html(baseDetailEn);
					 $('.richText-editor:eq(1)').html(baseDetailTc);
					 $('.richText-editor:eq(2)').html(baseDetailSc);
					 $('.richText-editor').attr('contenteditable', false);
					 
					 $('.forModifying').hide();
					 $('#baseThumbnailUrl').attr('required', 'required');
				 });
				 
			 });
			 
			// 수정하기 실행
			 $('#doModifyChallengeDetail').click(function() {
				 var textArr = [];
					$('#baseHabitTypeCd').children(':selected').each(function(index, element) {
						textArr.push($(element).text());
					});
					
					$('#searchKeyword').val(textArr.join(','));
			 });
			
			 // 모집 시작하기 버튼 처리
			 $('#startRecruiting').click(function() {
				 $('.forRecruiting').fadeIn('slow');
				 $('.forRecruiting input').attr('required', 'required');
				 
				 $('<li><a href="#" class="btn btn-primary">Cancel Editing</a></li>')
				 .appendTo('#headerBtn')
				 .siblings('li')
				 .hide()
				 .end()
				 .click(function() {
					 $(this)
					 	.siblings('li')
					 	.show()
					 	.end()
					 	.remove();
					 $('.forRecruiting').fadeOut('slow');
					 $('.forRecruiting input').removeAttr('required');
				 });
			 });
			 
			 // 인증 빈도 매일 체크박스 처리
			 $('#everyday').change(function() {
				 var dateCount = $('[name=baseAuthDateCd]:checked').length;
				 if(dateCount == 0) {
					 alert('Please select a valid day for verification.');
					 $(this).prop('checked', false);
				 } else {
					if($(this).prop('checked')) {
						
						var daysArr = [5, 2, 7];
						for(var i=0; i<daysArr.length; i++) {
							if($('#baseAuthDateCd' + (i+1)).prop('checked')) {
								 $('#baseAuthFrequency').val(daysArr[i]);
							}	
						}
						
						$('#baseAuthFrequency').attr('readonly', true);
					} else {
						$('#baseAuthFrequency').attr('readonly', false);
					}
				 }
			 });
			 
			 // 인증 가능 요일 라디오 처리
			 $('input[name=baseAuthDateCd]').change(function() {
				var daysArr = [5, 2, 7];
				for(var i=0; i<daysArr.length; i++) {
					if($('#baseAuthDateCd' + (i+1)).prop('checked')) {
						if($('#everyday').prop('checked')) {
							$('#baseAuthFrequency').val(daysArr[i]);
						}
					}	
				}
			 });
			 
			 // 인증 빈도 입력 처리
			 $('#baseAuthFrequency').blur(function() {
				 $baseAuthDateCd = $('[name=baseAuthDateCd]');
				 var $checkedDateCd = $baseAuthDateCd.filter(':checked');
				 
				 if($checkedDateCd.length > 0) {
					 var maxDayIndex = $baseAuthDateCd.index($checkedDateCd);
					 
					 var daysArr = [5, 2, 7];
					 var maxDay = daysArr[maxDayIndex];
					 if(parseInt($(this).val()) > maxDay) {
						 $(this).val(maxDay);
					 }
				 }
			 });
			 
			 // 24시간 체크박스 처리 
			 $('#allHours').change(function() {
				if($(this).prop('checked')) {
					$('#baseAuthFromTime').val('01:00').attr('readonly', true);
					$('#baseAuthToTime').val('23:59').attr('readonly', true);
				} else {
					$('#baseAuthFromTime').attr('readonly', false);
					$('#baseAuthToTime').attr('readonly', false);
				}
			 });
			 
			 // 인증샷 간격 제한없음 체크박스 처리
			 $('#noLimit').change(function() {
				 if($(this).prop('checked')) {
					 $('#intervalItem').hide();
					 $('#baseAuthInterval').val('0');
				 } else {
					 $('#intervalItem').show();
					 $('#baseAuthInterval').val('');
				 }
			 });
			 
			 // 제출시 습관타입을 키원드로 전환
			 $('#baseHabitTypeCd').change(function() {
				var textArr = [];
				$(this).children(':selected').each(function(index, element) {
					textArr.push($(element).text());
				});
				
				$('#searchKeyword').val(textArr.join(','));
			 });
			 
			 // 유효성 체크
			 function validateCheck($input, msg) {
				 var val = $input.val();
				 if(val == '') {
					 alert(msg);
					 $input.focus();
					 return false;
				 }
				 
				 return true;
			 }
			 
			 // 하단 모집 시작하기 버튼 처리
			 $('#createChallengeDetail').click(function(e) {
				 
				 if(!validateCheck($('#minFee'), 'Please input minimum fee.')) {
					 return false;
				 }
				 
				 if(!validateCheck($('#maxFee'), 'Please input maximum fee.')) {
					 return false;
				 }
				 
				 if(!validateCheck($('#startDate'), 'Please input start date.')) {
					 return false;
				 }
				 
				 if(!validateCheck($('#endDate'), 'Please input end date.')) {
					 return false;
				 }
				 
				 var token = $("meta[name='_csrf']").attr("content");
				 var header = $("meta[name='_csrf_header']").attr("content");
				 
				 $.ajax({ url: '/goalkeepinmanager/challenge/createNewOperatedChallenge',  
					 data: {
						 baseChallengeNo: $('#baseNo').val(),
						 categoryNo: $('#categoryNo').val(),
						 gradeCd: $('#gradeCd').val(),
						 minFee: $('#minFee').val(),
						 maxFee: $('#maxFee').val(),
						 startDate: $('#startDate').val(),
						 endDate: $('#endDate').val(),
						 baseAuthMethodCd: $('input[name=baseAuthDateCd]:checked').val(),
						 baseAuthFrequency: $('#baseAuthFrequency').val(),
						 baseAuthNumDaily: $('#baseAuthNumDaily').val()
		 			 },  
					 method: "POST",  
					 dataType: "text", 
					 beforeSend : function(xhr) {
					    xhr.setRequestHeader(header, token);
						}
					 })
					 .done(function(json) { 
						 window.location = '/goalkeepinmanager/challenge/showOperatedChallengeList/1?baseNo=' + $('#baseNo').val(); 
					 });
				 });

			 
			 // 등록한 챌린지 목록 버튼 처리
			 $('#showOperatedChallengeList').click(function() {
				 window.location = '/goalkeepinmanager/challenge/showOperatedChallengeList/1?baseNo=' + $('#baseNo').val();
			 });
			 
		});
	</script>
</body>
</html>
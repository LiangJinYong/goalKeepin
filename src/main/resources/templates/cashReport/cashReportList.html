<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:th="http://www.thymeleaf.org"
    xmlns:sec="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>Category List</title>
<link rel="stylesheet" href="../../../bootstrap.css">
<style type="text/css">
.waiting {
	color: red;
}

.finished {
	color: green;
}

header li {
	margin-top: 30px;
	margin-right: 3.2em;
	color: #777;
	font-weight: bold;
	color: #777
}

.row {
	margin: 15px 0 0 0;
}
</style>
</head>
<body>
	<form id="cashReportForm" method="get" th:action="@{/cashReport/showCashReportList/} + ${country} + '/1'">
		<div class="row">
			<header class="col-md-11 col-md-offset-1">
				<h1 class="brand pull-left">출금 내역 관리</h1>
				<ul class="list-inline list-unstyled pull-right" style="margin-right: 3.2em;">
					<li>
						<label>은행</label>
						<select name="bank" id="bank">
							<option value="">전체보기</option>
							<option th:each="bank: ${bankList}" th:value="${bank}" th:text="${bank}"></option>
						</select>
					</li>
					<li>
						<label>처리상태</label>
						<select name="reportStatusCd" id="reportStatusCd">
							<option value="CT00">전체보기</option>
							<option th:each="reportStatus : ${T(goalKeepin.constants.CashReportStatus).values()}"
			        			th:value="${reportStatus}" th:text="${reportStatus.statusName}"></option>
						</select>
					</li>
				</ul>
			</header>
		</div>
		
		<div class="row">
			<div class="col-md-10 col-md-offset-1">
				<table id="cashReportTable" class="table table-striped table-hover">
					<thead>
						<tr class="info">
							<th>
								<h2 class="h4 text-center">
									<input id="selectAll" type="checkbox">
								</h2>
							</th>
							<th>
								<h2 class="h4 text-center">NO</h2>
							</th>
							<th>
								<h2 class="h4 text-center">아이디</h2>
							</th>
							<th>
								<h2 class="h4 text-center">요청 금액</h2>
							</th>
							<th>
								<h2 class="h4 text-center">출근 계좌</h2>
							</th>
							<th>
								<h2 class="h4 text-center">날짜</h2>
							</th>
							<th>
								<h2 class="h4 text-center">처리상태</h2>
							</th>
						</tr>
					</thead>
					
					<tbody>
						<tr class="text-center" th:each="cashReport: ${cashReportList}" th:id="${cashReport.cashReportNo}">
							<td>
								<input th:if="${cashReport.reportStatusCd == 'CT01'}" type="checkbox" th:value="${cashReport.reportStatusCd}"  />
								<input th:if="${cashReport.reportStatusCd == 'CT02'}" type="checkbox" th:value="${cashReport.reportStatusCd}" checked="checked" onclick="return false;" />
							</td>
							<td th:text="${cashReport.cashReportNo}">NO</td>
							<td th:text="${cashReport.user.userId}">User Id</td>
							<td th:text="${cashReport.reportCashAmount}">Report Cash Amount</td>
							<td th:text="${cashReport.user.userAccount}">User Account</td>
							<td th:text="*{#dates.format(cashReport.reportRegDate, 'yyyy-MM-dd HH:mm:ss')}">Report Cash Date</td>
							<td th:if="${cashReport.reportStatusCd == 'CT01'}" th:text="${T(goalKeepin.constants.CashReportStatus).CT01.statusName}" class="waiting">Report Status Name</td>
							<td th:if="${cashReport.reportStatusCd == 'CT02'}" th:text="${T(goalKeepin.constants.CashReportStatus).CT02.statusName}" class="finished">Report Status Name</td>
						</tr>
					</tbody>
				</table>
			</div>
		</div>
		
		<div class="row text-center" th:if="${paging.totalPages > 0}">
			<nav aria-label="Page navigation">
				<ul class="pagination">
					<li th:each="i: ${#numbers.sequence(1, paging.totalPages)}" class="page-item" th:classappend="${paging.currentPageNum == i} ? 'active' : ''">
						<a class="page-link" th:href="@{'/cashReport/showCashReportList/' + ${country} + '/' + ${i}}" th:text="${i}"></a>
					</li>
				</ul>
			</nav>
		</div>
		
		<div class="row">
			<div class="col-md-10 col-md-offset-1">
				<div class="col-md-4">
				<a id="downloadExcel" th:href="@{/cashReport/excelDownload/} + ${country}" class="btn btn-primary">전체Excel다운</a>
				</div>
				<div class="col-md-1 col-md-offset-1 text-center">
					<a id="processCashReport" class="btn btn-success">선택한 요청 출금 처리</a>
				</div>
				<div class="col-md-4 pull-right">
					<input type="date" name="reportRegDate" id="reportRegDate" placeholder="날짜 검색" />
					<input type="submit" value="검색" /> <br />
					<input type="text" name="userId" id="userId" placeholder="아이디 검색" />
					<input type="submit" value="검색" />
				</div>
			</div>
		</div>
	</form>
	
	<script type="text/javascript" src="../../../jquery.js"></script>
	<script type="text/javascript" src="../../../data	Table.js"></script>
	<script th:inline="javascript">
	var bank = /*[[*{bank}]]*/ null;
	var reportStatusCd = /*[[*{reportStatusCd}]]*/ null;
	var reportRegDate = /*[[*{reportRegDate}]]*/ null;
	var userId = /*[[*{userId}]]*/ null;
	</script>
	<script type="text/javascript">
		$(function() {
			
			if(bank != null)
				$('#bank').val(bank);
			
			if(reportStatusCd != null)
				$('#reportStatusCd').val(reportStatusCd);
			
			if(reportRegDate != null)
				$('#reportRegDate').val(reportRegDate);
			
			if(userId != null)
				$('#userId').val(userId);
			
			$('#bank, #reportStatusCd').change(function() {
				$('#cashReportForm').submit();
			});
			
			$('#selectAll').change(function() {
				
				var isChecked = $(this).is(':checked');
				$('#cashReportTable input[value="CT01"]').prop('checked', isChecked);
			});
			
			$('#processCashReport').click(function() {
				var $checkedItems = $('#cashReportTable tr:has(input:checked[value="CT01"])');
				var length = $checkedItems.length;

				if(length == 0) {
					alert('처리할 출금 내역을 선택하세요.');
				} else {
					var idArr = [];
					$checkedItems.each(function(index, item) {
						idArr.push($(item).attr('id'));
					});
					
					$.post('/cashReport/processCashReport',
						{cashReportIdList: idArr},
						function(data) {
							if(data == 'success') {
								alert('출금 처리되었습니다.');
								$checkedItems.each(function(index, item) {
									$(item).find('input').val('CT02').change(function(e) {
										$(this).val('CT02').prop('checked', true);
									});
									
									$(item).children().last().text('완료').attr('class', 'finished');
								});
							} else {
								alert('출금 처리 실패했습니다.');
							}
						}, 'text');
				}
			});
		});
	</script>
</body>
</html>